# Epic 1.5: Commit Strategy & Breakdown

## Overview

Breaking Epic 1.5 into **20 atomic commits** organized into 4 phases. Each commit is self-contained, testable, and follows the dependency chain.

---

## Dependency Analysis

```
Task 1 (Types) ──────────┐
                         ├──> Task 2 (API Client) ──┐
                         │                          │
                         │                          ├──> Task 4 (Query Hooks) ──┐
                         │                          │                           │
Task 3 (Query Provider) ─┘                          │                           │
                                                     │                           ├──> Task 6-8 (Pages)
                                                     │                           │
Task 5 (Zustand Stores) ────────────────────────────┘                           │
                                                                                 │
Task 9 (Layout/Nav) ────────────────────────────────────────────────────────────┤
                                                                                 │
Task 10 (Loading/Errors) ───────────────────────────────────────────────────────┘
```

**Critical Path**: Tasks 1 → 2 → 4 → 7 (Types → API → Hooks → Token Extraction Page)

**Parallel Streams**:
- Stream A: Task 1 → 2 → 4 (API Integration)
- Stream B: Task 3 (Query Provider - can start after Task 1)
- Stream C: Task 5 (Zustand - independent, needs types from Task 1)
- Stream D: Task 6 (Dashboard - minimal dependencies)

---

## Phase 1: Foundation (Commits 1-7)
**Goal**: Setup types, API client, state management infrastructure

### Commit 1: Add TypeScript API types
**Scope**: Task 1 (partial)
```bash
feat(types): add API request/response interfaces

- Create app/src/types/api.types.ts with backend contract types
- Add TokenExtractionResponse, FigmaAuthRequest/Response
- Add FigmaExtractRequest/Response interfaces
- Add DesignTokens interface matching backend structure
- Add ImageMetadata helper type

Types match backend Pydantic models exactly.
Confidence scores are separate from token values.
```

**Files**:
- `app/src/types/api.types.ts` (new)

**Test**: `npm run build` succeeds, no type errors

---

### Commit 2: Add domain model types
**Scope**: Task 1 (partial)
```bash
feat(types): add domain model types for tokens and components

- Create app/src/types/token.types.ts for domain models
- Add TokenCategory, ConfidenceLevel enums
- Add ColorToken, TypographyToken, SpacingToken types
- Create app/src/types/component.types.ts for UI props
- Add central exports in app/src/types/index.ts

Separates API contracts from domain logic.
```

**Files**:
- `app/src/types/token.types.ts` (new)
- `app/src/types/component.types.ts` (new)
- `app/src/types/index.ts` (new)

**Test**: All types export correctly, no circular dependencies

---

### Commit 3: Install axios and setup API client
**Scope**: Task 2 (partial)
```bash
feat(api): setup axios client with interceptors

- Install axios: npm install axios
- Create app/src/lib/api/client.ts with configured axios instance
- Add request interceptor for headers
- Add response interceptor for error transformation
- Configure timeout: 30s for uploads, 10s for others
- Use NEXT_PUBLIC_API_URL from env (http://localhost:8000)

API client ready for endpoint wrappers.
```

**Files**:
- `package.json` (modified - axios added)
- `package-lock.json` (modified)
- `app/src/lib/api/client.ts` (new)

**Test**:
- Verify axios in package.json: `cat package.json | grep axios`
- Check installation: `npm ls axios`
- Import apiClient, verify config, test error interceptor

---

### Commit 4: Add token extraction API endpoints
**Scope**: Task 2 (partial)
```bash
feat(api): add token extraction endpoint wrappers

- Create app/src/lib/api/tokens.api.ts
- Add extractTokensFromScreenshot() with FormData upload
- Add getDefaultTokens() for shadcn/ui fallbacks
- Implement typed API functions using api.types.ts
- Add proper error handling for each endpoint

Screenshot upload and defaults API ready.
```

**Files**:
- `app/src/lib/api/tokens.api.ts` (new)

**Test**: Import functions, verify types, mock API calls

---

### Commit 5: Add Figma integration API endpoints
**Scope**: Task 2 (partial)
```bash
feat(api): add Figma integration endpoint wrappers

- Create app/src/lib/api/figma.api.ts
- Add authenticateFigma() for PAT validation
- Add extractTokensFromFigma() for file extraction
- Add invalidateFigmaCache() helper
- Implement typed API functions using api.types.ts

Figma API integration complete.
```

**Files**:
- `app/src/lib/api/figma.api.ts` (new)

**Test**: Import functions, verify types, mock responses

---

### Commit 6: Setup TanStack Query provider
**Scope**: Task 3
```bash
feat(query): setup TanStack Query provider with devtools

- Create app/src/lib/query/queryClient.ts
- Configure QueryClient with 5min staleTime (Figma cache TTL)
- Set retry: 3 with exponential backoff
- Create app/src/app/providers.tsx with QueryClientProvider
- Add React Query Devtools for development
- Wrap app in providers in layout.tsx

Server state management infrastructure ready.
✅ MILESTONE: App now runs with `npm run dev` (shows default page)
```

**Files**:
- `app/src/lib/query/queryClient.ts` (new)
- `app/src/app/providers.tsx` (new)
- `app/src/app/layout.tsx` (modified - first time)

**Test**: Devtools visible in browser, provider wraps app, `npm run dev` works

---

### Commit 7: Create Zustand stores for client state
**Scope**: Task 5
```bash
feat(state): add Zustand stores for tokens, workflow, and UI

- Create app/src/stores/useTokenStore.ts for extracted tokens
- Add setTokens, updateToken, clearTokens actions
- Create app/src/stores/useWorkflowStore.ts for multi-step flow
- Add setStep, updateProgress actions
- Create app/src/stores/useUIStore.ts for modals/alerts
- Add openModal, closeModal, showAlert actions
- Use TypeScript strict types for all stores

Client state management complete.
```

**Files**:
- `app/src/stores/useTokenStore.ts` (new)
- `app/src/stores/useWorkflowStore.ts` (new)
- `app/src/stores/useUIStore.ts` (new)

**Test**: Import stores, verify actions update state correctly

---

## Phase 2: Query Hooks & Integration (Commits 8-10)
**Goal**: Connect API client to TanStack Query and Zustand stores

### Commit 8: Add token extraction query hook
**Scope**: Task 4 (partial)
```bash
feat(hooks): add useTokenExtraction mutation hook

- Create app/src/lib/query/hooks/useTokenExtraction.ts
- Use useMutation for POST /tokens/extract/screenshot
- Update useTokenStore.setTokens() on success
- Handle loading, error, success states
- Return typed mutation object
- Integrate with Zustand store from commit 7

Screenshot extraction hook ready for UI.
```

**Files**:
- `app/src/lib/query/hooks/useTokenExtraction.ts` (new)

**Test**: Hook returns mutation, onSuccess updates store, verify store integration works

---

### Commit 9: Add Figma authentication query hook
**Scope**: Task 4 (partial)
```bash
feat(hooks): add useFigmaAuth mutation hook

- Create app/src/lib/query/hooks/useFigmaAuth.ts
- Use useMutation for POST /tokens/figma/auth
- Validate PAT format before API call
- Return authentication status with user email
- Handle authentication errors gracefully

Figma PAT validation hook ready.
```

**Files**:
- `app/src/lib/query/hooks/useFigmaAuth.ts` (new)

**Test**: Hook validates PAT, returns auth status

---

### Commit 10: Add Figma extraction query hook
**Scope**: Task 4 (partial)
```bash
feat(hooks): add useFigmaExtraction mutation hook

- Create app/src/lib/query/hooks/useFigmaExtraction.ts
- Use useMutation for POST /tokens/extract/figma
- Update useTokenStore on success
- Show cache indicator when cached: true
- Invalidate query on manual refresh

Figma file extraction hook complete.
```

**Files**:
- `app/src/lib/query/hooks/useFigmaExtraction.ts` (new)

**Test**: Hook extracts tokens, updates store, shows cache status

---

## Phase 3: Pages & UI Assembly (Commits 11-17)
**Goal**: Build all 5 pages using existing Epic 1 components

### Commit 11: Build dashboard home page
**Scope**: Task 6
```bash
feat(pages): create dashboard home page with quick actions

- Replace default Next.js content in app/src/app/page.tsx
- Import Link from 'next/link' for navigation
- Add ComponentForge header with app name/version
- Add metric cards with placeholder values (real metrics in future)
- Add Quick Actions card with "Extract Tokens" and "View Patterns" buttons
- Add Recent Generations card (empty state for now)
- Use Card, Button, MetricCard components from Epic 1
- Implement responsive layout (mobile/tablet/desktop)

Dashboard page complete, replaces default Next.js landing.
✅ MILESTONE: Dashboard visible at localhost:3000
Note: Full navigation chrome added in commit 18
```

**Files**:
- `app/src/app/page.tsx` (modified)

**Test**: Visit localhost:3000, see dashboard, button links work (no nav bar yet)

---

### Commit 12: Create token extraction page structure
**Scope**: Task 7 (partial)
```bash
feat(pages): create token extraction page with tabs layout

- Create app/src/app/extract/page.tsx
- Add page header "Extract Design Tokens"
- Implement Screenshot/Figma tabs using Tabs component
- Add tab structure with placeholders
- Import useTokenExtraction, useFigmaAuth hooks
- Connect to useTokenStore for state

Token extraction page structure ready for upload logic.
```

**Files**:
- `app/src/app/extract/page.tsx` (new)

**Test**: Page renders, tabs switch correctly

---

### Commit 13: Add screenshot upload to token extraction page
**Scope**: Task 7 (partial)
```bash
feat(extract): implement screenshot upload with drag-and-drop

- Add drag-and-drop upload zone in Screenshot tab
- Use native HTML5 file input (no react-dropzone dependency)
- Add file validation (PNG/JPG, max 10MB)
- Connect to useTokenExtraction hook
- Show upload progress with Progress component
- Display extracted tokens with Badge for confidence scores

Screenshot upload functional, tokens display with confidence.
```

**Files**:
- `app/src/app/extract/page.tsx` (modified)

**Test**: Upload screenshot, see progress, tokens extracted

---

### Commit 14: Add Figma integration to token extraction page
**Scope**: Task 7 (partial)
```bash
feat(extract): implement Figma PAT authentication and extraction

- Add PAT input with validation in Figma tab
- Add Figma URL input with format validation
- Connect to useFigmaAuth hook for PAT validation
- Connect to useFigmaExtraction hook for file extraction
- Show cache indicator (5 min TTL) when cached: true
- Display extracted tokens with confidence scores

Figma integration complete on token extraction page.
```

**Files**:
- `app/src/app/extract/page.tsx` (modified)

**Test**: Enter PAT, validate, extract from Figma URL

---

### Commit 15: Add token editor and export to extraction page
**Scope**: Task 7 (final)
```bash
feat(extract): add token editing and export functionality

- Integrate TokenEditor component from Epic 1
- Display tokens with ColorPicker, TypographyEditor, SpacingEditor
- Allow inline editing of all token values
- Add TokenExport component for JSON/CSS export
- Add "Continue to Requirements" button → /requirements
- Implement error handling with Alert component
- Add inline loading state during extraction (using isLoading)

Token extraction page complete with full workflow.
✅ MILESTONE: Core feature (token extraction) fully functional
Note: Page-level loading skeleton added in commit 19
```

**Files**:
- `app/src/app/extract/page.tsx` (modified)

**Test**: Edit tokens, export JSON/CSS, navigate to requirements, loading state shows

---

### Commit 16: Create requirements review page (placeholder)
**Scope**: Task 8 (partial)
```bash
feat(pages): create requirements review page with placeholders

- Create app/src/app/requirements/page.tsx
- Add page header "Review Requirements"
- Use RequirementCard, Accordion, EditModal components
- Display placeholder requirements grouped by category
- Add Accept/Review/Edit actions (UI only, no backend)
- Add bulk actions toolbar (Accept All, Review Low Confidence)
- Add "Continue to Patterns" button → /patterns

Requirements page structure ready for Epic 2 backend.
```

**Files**:
- `app/src/app/requirements/page.tsx` (new)

**Test**: Page renders, placeholders display, navigation works

---

### Commit 17: Create pattern selection and preview pages (placeholders)
**Scope**: Task 8 (partial)
```bash
feat(pages): create pattern selection and component preview pages

- Create app/src/app/patterns/page.tsx with placeholder patterns
- Use PatternCard component with confidence scores
- Add search input with Input component
- Add pattern preview Dialog
- Create app/src/app/preview/page.tsx with placeholder code
- Use Tabs for Preview/Code/Storybook/Quality tabs
- Use CodeBlock for syntax-highlighted code display
- Use MetricCard for quality metrics

Pattern selection and preview pages ready for Epic 3-4.
```

**Files**:
- `app/src/app/patterns/page.tsx` (new)
- `app/src/app/preview/page.tsx` (new)

**Test**: Pages render, placeholders work, navigation flows

---

## Phase 4: Navigation & Polish (Commits 18-20)
**Goal**: Add app shell, navigation, loading states, error handling

### Commit 18: Create app navigation and layout
**Scope**: Task 9
```bash
feat(layout): add navigation bar and app layout wrapper

- Create app/src/components/layout/Navigation.tsx
- Add nav links for Dashboard, Extract, Requirements, Patterns, Preview
- Highlight active page with usePathname
- Add workflow progress indicator (0-100%)
- Create app/src/components/layout/Footer.tsx
- Show app version from package.json
- Update layout.tsx to include Navigation and Footer (second modification)
- Implement responsive mobile menu

App navigation complete with workflow progress tracking.
✅ MILESTONE: Full navigation UX complete
```

**Files**:
- `app/src/components/layout/Navigation.tsx` (new)
- `app/src/components/layout/Footer.tsx` (new)
- `app/src/app/layout.tsx` (modified - second time, first was commit 6)

**Test**: Navigation visible, active page highlighted, footer shows version, progress indicator updates

---

### Commit 19: Add loading states for all pages
**Scope**: Task 10 (partial)
```bash
feat(loading): add loading skeletons for async page transitions

- Create app/src/app/extract/loading.tsx with Skeleton components
- Create app/src/app/requirements/loading.tsx
- Create app/src/app/patterns/loading.tsx
- Create app/src/app/preview/loading.tsx
- Use Skeleton component from Epic 1
- Match wireframe designs for loading states
- Implement Suspense boundaries for async data

Loading states display during navigation and data fetching.
```

**Files**:
- `app/src/app/extract/loading.tsx` (new)
- `app/src/app/requirements/loading.tsx` (new)
- `app/src/app/patterns/loading.tsx` (new)
- `app/src/app/preview/loading.tsx` (new)

**Test**: Navigate between pages, see loading skeletons

---

### Commit 20: Add error boundaries and error handling
**Scope**: Task 10 (final)
```bash
feat(errors): add global error boundary and error handling

- Create app/src/app/error.tsx with Error component
- Display user-friendly error message from error.message
- Add "Try Again" button using reset() function
- Use Alert component from Epic 1 for error display
- Add error logging to console for debugging
- Test error recovery flow

Error handling complete, users see friendly messages on failures.

Closes #12 (Epic 1.5: Frontend Integration & Page Assembly)
```

**Files**:
- `app/src/app/error.tsx` (new)

**Test**: Trigger error, see error boundary, click "Try Again"

---

## Commit Message Format

All commits follow Conventional Commits:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types**: `feat`, `fix`, `refactor`, `test`, `docs`, `chore`

**Scopes**: `types`, `api`, `query`, `hooks`, `state`, `pages`, `layout`, `loading`, `errors`

---

## Testing Strategy Per Commit

### Phase 1 (Foundation)
- **Commits 1-2**: `npm run build` passes, no type errors
- **Commits 3-5**: Import functions, verify types compile
- **Commit 6**: Devtools visible in browser
- **Commit 7**: Store actions update state correctly

### Phase 2 (Hooks)
- **Commits 8-10**: Mock API calls, verify store updates

### Phase 3 (Pages)
- **Commits 11-17**: Visual testing in browser, navigation works

### Phase 4 (Polish)
- **Commits 18-20**: E2E testing, error scenarios

---

## Rollback Strategy

Each commit is atomic and can be reverted independently:

```bash
# Revert last commit
git revert HEAD

# Revert specific commit
git revert <commit-hash>

# Revert range (Phase 3 pages)
git revert HEAD~7..HEAD~1
```

**Safe to revert**:
- Phase 4 commits (18-20) - Removes polish, core still works
- Individual page commits (16-17) - Other pages unaffected
- Individual hook commits (8-10) - Other hooks work

**Risky to revert** (breaks dependencies):
- Commit 1-2 (types) - Everything depends on types
- Commit 3-5 (API client) - Hooks need API functions
- Commit 6 (QueryProvider) - Hooks need provider

---

## Branch Strategy (Optional)

Can use feature branches per phase:

```bash
# Phase 1: Foundation
git checkout -b epic-1.5/phase-1-foundation
# Commits 1-7
git push origin epic-1.5/phase-1-foundation

# Phase 2: Hooks
git checkout -b epic-1.5/phase-2-hooks
# Commits 8-10
git push origin epic-1.5/phase-2-hooks

# Phase 3: Pages
git checkout -b epic-1.5/phase-3-pages
# Commits 11-17
git push origin epic-1.5/phase-3-pages

# Phase 4: Polish
git checkout -b epic-1.5/phase-4-polish
# Commits 18-20
git push origin epic-1.5/phase-4-polish
```

Or work directly on `main` if preferred.

---

## Estimated Timeline

**Total**: 20 commits

- **Phase 1** (7 commits): ~4 hours (foundation setup)
- **Phase 2** (3 commits): ~2 hours (query hooks)
- **Phase 3** (7 commits): ~6 hours (page assembly)
- **Phase 4** (3 commits): ~2 hours (polish)

**Total Estimate**: ~14 hours

**Per Commit Average**: ~40 minutes

---

## Key Principles

1. ✅ **Atomic**: Each commit is self-contained and testable
2. ✅ **Sequential**: Commits follow dependency order
3. ✅ **Reversible**: Any commit can be reverted safely
4. ✅ **Traceable**: Clear commit messages with scope
5. ✅ **Incremental**: Progressive enhancement, no big bangs

---

## Definition of Done (Per Commit)

- [ ] Code compiles without errors
- [ ] Types are correct (no `any` without justification)
- [ ] Manual testing passed (in browser)
- [ ] Commit message follows convention
- [ ] No broken imports
- [ ] No console errors
- [ ] Existing functionality unaffected

---

## Review Summary & Corrections Applied

**Review Date**: 2025-10-04

### Issues Found & Fixed

1. ✅ **Added Milestones** - Clarified when app is runnable:
   - Commit 6: App runs with `npm run dev`
   - Commit 11: Dashboard visible at localhost:3000
   - Commit 15: Core feature (token extraction) functional
   - Commit 18: Full navigation UX complete

2. ✅ **Clarified Layout Modifications** - Noted layout.tsx modified twice:
   - Commit 6: First modification (add Providers)
   - Commit 18: Second modification (add Navigation/Footer)

3. ✅ **Fixed Missing Import** - Added `import Link from 'next/link'` to commit 11

4. ✅ **Clarified Loading States** - Distinguished inline vs page-level:
   - Commit 15: Inline loading state (using isLoading)
   - Commit 19: Page-level loading skeleton files

5. ✅ **Enhanced Store Integration Test** - Commit 8 now verifies:
   - Hook-to-store integration works correctly
   - Store updates on mutation success

6. ✅ **Added Axios Verification** - Commit 3 test now includes:
   - Verify axios in package.json
   - Check npm installation succeeded

7. ✅ **Documented Navigation Timing** - Commit 11 notes:
   - Links work but navigation chrome comes in commit 18

8. ✅ **Clarified Metrics** - Commit 11 notes:
   - Placeholder values shown (real metrics in future)

### Remaining Considerations

**Not Fixed (Intentional Design)**:

1. **Dashboard Before Extraction** - Dashboard (commit 11) before extraction (12-15)
   - Rationale: "Simple first" approach, dashboard is minimal
   - Alternative: Could swap order for "core feature first"
   - Decision: Keep current order for incremental complexity

2. **No useMetricsStore** - Dashboard metrics are placeholders
   - Rationale: Real metrics come with Epic 5 (Quality Validation)
   - Current: Hardcoded "0" and "N/A" values
   - Future: Epic 5 will add real metrics store

3. **Layout Modified Twice** - layout.tsx changed in commits 6 and 18
   - Rationale: Sequential enhancements, no conflict
   - Commit 6: Infrastructure (providers)
   - Commit 18: UI chrome (nav/footer)
   - Decision: This is acceptable practice

### Validation Checklist

- [x] All dependencies in correct order
- [x] Each commit is atomic and testable
- [x] Milestones clearly marked
- [x] File modification conflicts noted
- [x] Missing imports documented
- [x] Store integration verified
- [x] Package installation validated
- [x] UX completeness timeline clear

### Final Recommendation

**Strategy is production-ready** with corrections applied. All critical issues addressed. Remaining considerations are intentional design choices that don't block implementation.
