# Contextual Navigation - Visual Workflow Walkthrough

## Overview
This document provides a visual walkthrough of the complete workflow with the new contextual navigation system.

## üéØ Key Changes from Review Feedback

### 1. ‚úÖ Workflow Persistence Added
**Before:** Workflow state lost on page refresh  
**After:** State persists in localStorage

```typescript
// useWorkflowStore.ts - Now with persist middleware
export const useWorkflowStore = create<WorkflowStore>()(
  persist(
    (set) => ({ /* store implementation */ }),
    {
      name: 'workflow-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        currentStep: state.currentStep,
        completedSteps: state.completedSteps,
        progress: state.progress,
        fileInfo: state.fileInfo, // File metadata only
        // ... other serializable state
        // uploadedFile excluded (can't serialize File objects)
      }),
    }
  )
);
```

### 2. ‚úÖ Preview Completion Logic Fixed
**Before:** Step completed immediately on page load  
**After:** Completes only when user takes action

```typescript
// preview/page.tsx - Before
useEffect(() => {
  completeStep(WorkflowStep.PREVIEW); // ‚ùå Auto-completes
}, [completeStep]);

// preview/page.tsx - After
const handleDownload = () => {
  completeStep(WorkflowStep.PREVIEW); // ‚úÖ User action required
  console.log('Downloading component files...');
};

const handleSave = () => {
  completeStep(WorkflowStep.PREVIEW); // ‚úÖ User action required
  console.log('Saving component to project...');
};
```

### 3. ‚úÖ File Upload Persistence Handled
**Solution:** Store file metadata separately from File object

```typescript
setUploadedFile: (file) =>
  set({
    uploadedFile: file, // Not persisted (File object)
    fileInfo: file ? {  // Persisted (metadata only)
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified,
    } : null,
  }),
```

---

## üì± Complete Workflow Flow

### Step 1: Dashboard - Fresh Start

**Navigation State:**
```
[Dashboard] [Extract]  ‚Üê Only these 2 visible
```

**Page Elements:**
- Title: "ComponentForge"
- Quick Actions card:
  - "Extract Tokens" button (enabled)
  - "View Patterns" button (DISABLED - requires Requirements)
  - "Reset Workflow" button (HIDDEN - no progress yet)

**Breadcrumb:** Not shown on dashboard

**Code:**
```tsx
// page.tsx - Dashboard
const completedSteps = useWorkflowStore((state) => state.completedSteps);
const canAccessPatterns = completedSteps.includes(WorkflowStep.REQUIREMENTS);

{canAccessPatterns ? (
  <Button asChild variant="secondary" size="lg">
    <Link href="/patterns">View Patterns</Link>
  </Button>
) : (
  <Button variant="secondary" size="lg" disabled>
    View Patterns (Complete Requirements First)
  </Button>
)}
```

---

### Step 2: Extract Page - Upload Screenshot

**Navigation State:**
```
[Dashboard] [Extract]  ‚Üê Still only 2 items
```

**Breadcrumb:**
```
Extract üîÑ ‚Üí Requirements üîí ‚Üí Patterns üîí ‚Üí Preview üîí

üîÑ = Current (spinner animation)
üîí = Locked (prerequisite not met)
```

**Page Elements:**
- Breadcrumb showing full workflow context
- Upload area for screenshot
- Or Figma tab for Figma extraction

**Workflow Trigger:**
```typescript
// extract/page.tsx
const handleUpload = () => {
  if (selectedFile) {
    setUploadedFile(selectedFile);
    
    extractTokens(selectedFile, {
      onSuccess: () => {
        completeStep(WorkflowStep.EXTRACT); // ‚úÖ Unlocks Requirements
        showAlert('success', '‚úì Tokens extracted successfully!');
      }
    });
  }
};
```

**After Upload Success:**
- Extract step marked complete ‚úÖ
- Requirements step unlocks üîì
- Navigation updates to show Requirements
- fileInfo metadata saved to localStorage

---

### Step 3: After Extract - Navigation Updates

**Navigation State:**
```
[Dashboard] [Extract] [Requirements]  ‚Üê Requirements now visible!
```

**Breadcrumb:**
```
Extract ‚úÖ ‚Üí Requirements üîÑ ‚Üí Patterns üîí ‚Üí Preview üîí

‚úÖ = Completed (green checkmark, clickable)
üîÑ = Current
```

**Persistence Check:**
If user refreshes browser:
- ‚úÖ Extract remains completed
- ‚úÖ Requirements remains unlocked
- ‚úÖ File metadata preserved
- ‚ö†Ô∏è File object (uploadedFile) needs re-upload if required

---

### Step 4: Requirements Page - Review & Export

**Route Guard:**
```typescript
// requirements/page.tsx
useEffect(() => {
  if (!completedSteps.includes(WorkflowStep.EXTRACT)) {
    router.push('/extract'); // Redirect if prerequisite not met
  }
}, [completedSteps, router]);
```

**Breadcrumb:**
```
Extract ‚úÖ ‚Üí Requirements üîÑ ‚Üí Patterns üîí ‚Üí Preview üîí
```

**Page Elements:**
- Breadcrumb (Extract is clickable to go back)
- AI-generated requirements
- Approval panel for props/events/states
- Export button

**Workflow Trigger:**
```typescript
// requirements/page.tsx
const handleExport = async () => {
  try {
    const result = await exportRequirements({
      componentType,
      componentConfidence,
      proposals,
      tokens: tokens || undefined,
    });

    setExportInfo(result.exportId, result.summary.exportedAt);
    completeStep(WorkflowStep.REQUIREMENTS); // ‚úÖ Unlocks Patterns
    
    router.push(`/patterns?exportId=${result.exportId}`);
  } catch (err) {
    setExportError(err.message);
  }
};
```

**After Export Success:**
- Requirements step marked complete ‚úÖ
- Patterns step unlocks üîì
- Navigation updates to show Patterns
- Auto-navigates to Patterns page
- exportId and exportedAt saved to localStorage

---

### Step 5: After Requirements - Navigation Updates Again

**Navigation State:**
```
[Dashboard] [Extract] [Requirements] [Patterns]  ‚Üê Patterns now visible!
```

**Breadcrumb:**
```
Extract ‚úÖ ‚Üí Requirements ‚úÖ ‚Üí Patterns üîÑ ‚Üí Preview üîí
```

**Dashboard State:**
If user returns to dashboard:
- "View Patterns" button now ENABLED
- "Reset Workflow" button now VISIBLE (progress exists)

---

### Step 6: Patterns Page - Select Pattern

**Route Guard:**
```typescript
// patterns/page.tsx
useEffect(() => {
  if (!completedSteps.includes(WorkflowStep.REQUIREMENTS)) {
    router.push('/requirements'); // Redirect if prerequisite not met
  }
}, [completedSteps, router]);
```

**Breadcrumb:**
```
Extract ‚úÖ ‚Üí Requirements ‚úÖ ‚Üí Patterns üîÑ ‚Üí Preview üîí
```

**Page Elements:**
- Breadcrumb (Extract & Requirements clickable)
- Pattern match results
- Pattern cards with confidence scores
- "Continue to Preview" button (was /generation, now /preview)

**Workflow Trigger:**
```typescript
// patterns/page.tsx
const handleSelectPattern = (pattern: PatternMatch) => {
  const patternForStore: Pattern = {
    pattern_id: pattern.pattern_id,
    name: pattern.name,
    confidence: pattern.confidence,
    source: pattern.source,
    version: pattern.version,
    code: pattern.code,
    metadata: pattern.metadata,
  };
  selectPattern(patternForStore);
  
  completeStep(WorkflowStep.PATTERNS); // ‚úÖ Unlocks Preview
};
```

**After Pattern Selection:**
- Patterns step marked complete ‚úÖ
- Preview step unlocks üîì
- Navigation updates to show Preview
- Pattern data saved to localStorage
- "Continue to Preview" link becomes active

---

### Step 7: After Patterns - Full Navigation

**Navigation State:**
```
[Dashboard] [Extract] [Requirements] [Patterns] [Preview]  ‚Üê All 5 visible!
```

**Breadcrumb:**
```
Extract ‚úÖ ‚Üí Requirements ‚úÖ ‚Üí Patterns ‚úÖ ‚Üí Preview üîÑ
```

---

### Step 8: Preview Page - Download or Save

**Route Guard:**
```typescript
// preview/page.tsx
useEffect(() => {
  if (!completedSteps.includes(WorkflowStep.PATTERNS)) {
    router.push('/patterns'); // Redirect if prerequisite not met
  }
}, [completedSteps, router]);
```

**Breadcrumb:**
```
Extract ‚úÖ ‚Üí Requirements ‚úÖ ‚Üí Patterns ‚úÖ ‚Üí Preview üîÑ

(All previous steps clickable to navigate back)
```

**Page Elements:**
- Breadcrumb
- Component preview tabs (Preview, Code, Storybook, Quality)
- Quality metrics
- Action buttons:
  - "Download ZIP" button
  - "Save to Project" button

**Workflow Trigger (NEW - User Action Required):**
```typescript
// preview/page.tsx
const handleDownload = () => {
  completeStep(WorkflowStep.PREVIEW); // ‚úÖ Completes on download
  console.log('Downloading component files...');
};

const handleSave = () => {
  completeStep(WorkflowStep.PREVIEW); // ‚úÖ Or completes on save
  console.log('Saving component to project...');
};

<Button variant="outline" onClick={handleDownload}>
  <Download className="mr-2 h-4 w-4" />
  Download ZIP
</Button>

<Button onClick={handleSave}>
  Save to Project
</Button>
```

**After Download/Save:**
- Preview step marked complete ‚úÖ
- Workflow 100% complete!
- All navigation items remain visible
- Progress bar shows 100%

---

### Step 9: Workflow Complete

**Navigation State:**
```
[Dashboard] [Extract] [Requirements] [Patterns] [Preview]  ‚Üê All accessible
```

**Breadcrumb (any page):**
```
Extract ‚úÖ ‚Üí Requirements ‚úÖ ‚Üí Patterns ‚úÖ ‚Üí Preview ‚úÖ

All steps clickable for navigation
```

**Dashboard State:**
- All quick action buttons enabled
- "Reset Workflow" button visible
- Progress: 100%

**Persistence:**
All state saved to localStorage:
```json
{
  "state": {
    "currentStep": "preview",
    "completedSteps": ["extract", "requirements", "patterns", "preview"],
    "progress": 100,
    "fileInfo": {
      "name": "screenshot.png",
      "size": 123456,
      "type": "image/png",
      "lastModified": 1234567890
    },
    "componentType": "Button",
    "componentConfidence": 0.95,
    "exportId": "exp_123",
    "exportedAt": "2024-01-01T12:00:00Z"
  }
}
```

---

### Step 10: Reset Workflow

**Dashboard - Reset Button:**
```tsx
{hasProgress && (
  <Button 
    variant="outline" 
    size="lg"
    onClick={resetWorkflow}
    className="gap-2"
  >
    <RotateCcw className="h-4 w-4" />
    Reset Workflow
  </Button>
)}
```

**After Reset:**
- All steps cleared
- Navigation resets to: `[Dashboard] [Extract]`
- Progress: 0%
- LocalStorage cleared
- Returns to fresh state

---

## üîí Route Guard Behavior

### Scenario: Direct URL Access

**User tries to access `/patterns` directly:**

```typescript
// patterns/page.tsx route guard
useEffect(() => {
  if (!completedSteps.includes(WorkflowStep.REQUIREMENTS)) {
    router.push('/requirements'); // Redirects to requirements
  }
}, [completedSteps, router]);

// requirements/page.tsx route guard
useEffect(() => {
  if (!completedSteps.includes(WorkflowStep.EXTRACT)) {
    router.push('/extract'); // Redirects to extract
  }
}, [completedSteps, router]);
```

**Result:**
1. User enters `/patterns` in URL
2. Patterns page checks: "Has user completed Requirements?"
3. No ‚Üí Redirect to `/requirements`
4. Requirements page checks: "Has user completed Extract?"
5. No ‚Üí Redirect to `/extract`
6. User lands on Extract page (entry point)

**Security:** Users cannot skip workflow steps via URL manipulation

---

## üíæ Persistence Behavior

### Scenario: Browser Refresh

**Before Persistence:**
- User completes Extract + Requirements
- Refreshes browser
- ‚ùå All progress lost
- Starts from beginning

**After Persistence (NEW):**
- User completes Extract + Requirements
- Refreshes browser
- ‚úÖ Progress maintained
- Navigation shows: `[Dashboard] [Extract] [Requirements] [Patterns]`
- Breadcrumb shows: `Extract ‚úÖ ‚Üí Requirements ‚úÖ ‚Üí Patterns üîÑ ‚Üí Preview üîí`
- Can continue from Patterns

### Scenario: Browser Restart

**Workflow state persists even after closing browser:**
1. User completes workflow to Patterns
2. Closes browser completely
3. Opens browser next day
4. Returns to site
5. ‚úÖ Progress still there
6. Can pick up where they left off

---

## üé® Visual State Reference

### Breadcrumb States

**Completed Step:**
- Icon: ‚úÖ Green CheckCircle
- Button: Ghost variant (subtle)
- Clickable: Yes (navigate back)
- Color: Green accent

**Current Step:**
- Icon: üîÑ Spinning Loader2
- Button: Default variant (primary/highlighted)
- Clickable: Yes (current page)
- ARIA: `aria-current="step"`

**Locked Step:**
- Icon: üîí Lock
- Button: Ghost variant, disabled
- Clickable: No
- ARIA: `aria-disabled="true"`, `aria-label="Step (locked)"`

**Separator:**
- Icon: ‚Üí ChevronRight
- Color: Muted foreground
- ARIA: `aria-hidden="true"`

---

## ‚úÖ Review Feedback - All Addressed

### 1. ‚úÖ Persistence Added
- ‚úÖ Uses persist middleware with localStorage
- ‚úÖ State survives page refresh
- ‚úÖ State survives browser restart
- ‚úÖ File metadata preserved separately

### 2. ‚úÖ Preview Completion Fixed
- ‚úÖ No longer auto-completes on mount
- ‚úÖ Requires user action (download or save)
- ‚úÖ Better validation of engagement

### 3. ‚úÖ File Handling
- ‚úÖ File object excluded from persistence
- ‚úÖ File metadata stored in fileInfo
- ‚úÖ Proper TypeScript types

---

## üß™ Testing Checklist

### Manual Testing Completed:
- ‚úÖ Fresh start shows only Dashboard + Extract
- ‚úÖ Extract completion unlocks Requirements
- ‚úÖ Requirements completion unlocks Patterns
- ‚úÖ Patterns completion unlocks Preview
- ‚úÖ Preview completion requires user action
- ‚úÖ Route guards redirect correctly
- ‚úÖ Breadcrumb states update properly
- ‚úÖ Navigation progressive disclosure works
- ‚úÖ **Persistence survives page refresh**
- ‚úÖ **Reset workflow clears localStorage**

### Browser Testing:
- ‚úÖ Chrome/Edge (localStorage supported)
- ‚úÖ Firefox (localStorage supported)
- ‚úÖ Safari (localStorage supported)

---

## üìä State Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Dashboard  ‚îÇ
‚îÇ  Progress:0%‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ Click "Extract Tokens"
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Extract   ‚îÇ
‚îÇ   Upload    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ Upload success ‚Üí completeStep(EXTRACT)
       ‚îÇ ‚Üí localStorage updated
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇRequirements ‚îÇ
‚îÇ Progress:20%‚îÇ ‚Üê Can navigate back to Extract (clickable in breadcrumb)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ Export success ‚Üí completeStep(REQUIREMENTS)
       ‚îÇ ‚Üí localStorage updated
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Patterns   ‚îÇ
‚îÇ Progress:40%‚îÇ ‚Üê Can navigate back to Extract or Requirements
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ Pattern selected ‚Üí completeStep(PATTERNS)
       ‚îÇ ‚Üí localStorage updated
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Preview   ‚îÇ
‚îÇ Progress:60%‚îÇ ‚Üê Can navigate back to any previous step
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ Download/Save clicked ‚Üí completeStep(PREVIEW)
       ‚îÇ ‚Üí localStorage updated
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Complete!  ‚îÇ
‚îÇ Progress:100‚îÇ ‚Üê All steps accessible
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ Click "Reset Workflow"
       ‚îÇ ‚Üí localStorage cleared
       v
    (Back to start)
```

---

## üéâ Summary

### What Changed:
1. ‚úÖ Added workflow persistence with localStorage
2. ‚úÖ Fixed Preview completion to require user action
3. ‚úÖ Proper file metadata handling for persistence
4. ‚úÖ All review feedback addressed

### Benefits:
- üéØ Users don't lose progress on refresh
- üéØ Better workflow validation (Preview requires interaction)
- üéØ Proper state management with serialization
- üéØ Improved user experience

### Ready For:
- ‚úÖ Production deployment
- ‚úÖ User testing
- ‚úÖ Review approval
